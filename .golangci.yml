# golangci-lint configuration for s9s
version: "2"

run:
  timeout: 10m
  tests: true
  skip-dirs:
    - vendor
    - .git
    - .github

linters:
  disable-all: true
  enable:
    # Core linters - focusing on critical issues only
    - errcheck      # Unchecked errors are critical
    - govet         # Suspicious constructs
    - ineffassign   # Ineffective assignments
    # staticcheck: 50 issues fixed in PR #13, 32 remaining to be addressed in Phase 1
    # gosec: 105 issues fixed in PR #12, remaining issues in auth/config packages
    # Will be re-enabled as Phase 1 & 2 issues are resolved

    # Additional linters - Phase 7
    # Note: gofumpt and goimports are handled by pre-commit hooks and Makefile
    - misspell      # Check for commonly misspelled English words
    - bodyclose     # Check HTTP response body is closed
    - errorlint     # Find code that will cause problems with Go 1.13 error wrapping (fixed in this PR)
    - wastedassign  # Finds wasted assignment statements (fixed in this PR)

  disable:
    # Temporarily disabled - will be fixed in follow-up PRs
    - unused        # 1 issue
    # staticcheck: Progress - 50/71 issues fixed (Phase 2 PR #13)
    # Remaining 32 issues: SA9003 (27), QF1008 (2), QF1003 (1), other (2)
    # Phase 1 work: s9s-w3f (SA9003), s9s-0tx (QF1008/QF1003)
    - staticcheck
    # gosec: Progress - 105/145 issues fixed (Phase 1 PR #12)
    # Remaining issues are in auth/config packages, see exclude rules below
    - gosec
    - gocritic      # 51 pre-existing style issues (ifElseChain, singleCaseSwitch, dupBranchBody)
    - noctx         # 23 pre-existing issues in test HTTP requests
    - prealloc      # 16 pre-existing performance micro-optimizations
    - unconvert     # 8 pre-existing unnecessary type conversions
    - unparam       # 38 pre-existing unused parameters

linters-settings:
  errcheck:
    check-type-assertions: true
    check-blank: false  # Allow _ = assignment for intentionally ignored errors

  govet:
    enable:
      - shadow

  gosec:
    # Security severity threshold
    severity: medium
    confidence: medium
    # Exclude specific rules that are false positives or acceptable in our context
    excludes:
      # G204 is often a false positive when using exec.Command with separate args
      # We've reviewed all exec.Command usage and they use proper argument separation
      - G204

  gocritic:
    # Enable multiple checks by tags
    enabled-tags:
      - diagnostic
      - performance
      - style
    disabled-checks:
      - dupImport # https://github.com/go-critic/go-critic/issues/845
      - ifElseChain  # Style preference, too many pre-existing instances
      - singleCaseSwitch  # Style preference, too many pre-existing instances
      - dupBranchBody  # Acceptable in some cases
      - octalLiteral
      - whyNoLint

  errorlint:
    # Check whether fmt.Errorf uses the %w verb for formatting errors
    errorf: true
    # Check for plain type assertions and type switches
    asserts: true
    # Check for plain error comparisons
    comparison: true

  misspell:
    # Correct spellings using locale preferences for US or UK
    locale: US

issues:
  exclude-files:
    - ".*\\.pb\\.go$"
    - ".*\\.gen\\.go$"

  exclude-dirs:
    - vendor
    - third_party
    - testdata

  exclude-rules:
    # Exclude shadow warnings for common err pattern
    - text: "shadow: declaration of \"err\""
      linters:
        - govet

    # G304: File inclusion via variable is acceptable for application-controlled paths
    # These are not user-supplied paths but application configuration
    - text: "G304:"
      linters:
        - gosec
      path: "(export|filters|preferences|config)/"

    # G301/G306: Allow standard file permissions in specific contexts
    # Test files, setup wizards, and exports may use standard Unix permissions
    - text: "(G301|G306):"
      linters:
        - gosec
      path: "(test|setup|export|filters)/"

    # unparam: Unused parameters in tests are acceptable
    - text: "- .* is unused"
      linters:
        - unparam
      path: "_test\\.go"

    # unparam: Functions that always return nil are acceptable if designed for future errors
    # These functions are intentionally designed to return errors for extensibility
    - text: "result 0 \\(error\\) is always nil"
      linters:
        - unparam
      path: "internal/app/app\\.go"

    # Exclude certain linters from test files - tests have different patterns
    - linters:
        - unparam
        - prealloc
        - gocritic
      path: "_test\\.go"

    # noctx: Test HTTP requests don't need context
    - linters:
        - noctx
      path: "(test|_test)\\.go"

    # Pre-existing staticcheck issues - Phase 1 work items
    # SA9003: empty branch (27 instances) - task s9s-w3f
    # QF1008: could remove embedded field (2 instances) - task s9s-0tx
    # QF1003: could use tagged switch (1 instance) - task s9s-0tx
    # These will be fixed when staticcheck is re-enabled
    - text: "SA9003: empty branch"
      linters:
        - staticcheck

    - text: "QF1008: could remove embedded field"
      linters:
        - staticcheck

    - text: "QF1003: could use tagged switch"
      linters:
        - staticcheck

    # Pre-existing gosec issues in auth and config packages
    - text: "G404: Use of weak random"
      linters:
        - gosec
      path: "internal/auth/"

    - text: "(G301|G304|G306):"
      linters:
        - gosec
      path: "(internal/auth|internal/config|internal/cli)/"

    # Pre-existing unconvert issues
    - linters:
        - unconvert

    # Pre-existing unparam issues (except in files we specifically modified)
    - linters:
        - unparam
      path: "internal/(views|ui|layouts|discovery|monitoring|ssh)/"

    # Pre-existing prealloc suggestions
    - linters:
        - prealloc

  max-issues-per-linter: 0
  max-same-issues: 0
